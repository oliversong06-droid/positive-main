<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ê¸° ë·°ì–´</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            min-height: 100vh; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px; 
        }
        .header a {
            color: white;
            text-decoration: none;
            font-size: 1.1em;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        .header a:hover {
            opacity: 1;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            height: calc(100vh - 150px);
        }
        .selected-diary, .related-diaries {
            background: var(--theme-color, #667eea);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            position: relative;
        }
        .selected-diary {
            color: var(--text-color, white);
        }
        .related-diaries {
            background: var(--theme-color-light, rgba(255, 255, 255, 0.1));
            color: var(--text-color, white);
        }
        .diary-title {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-color, white);
        }
        .diary-meta {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 25px;
            color: var(--text-color, white);
        }
        .diary-content {
            font-size: 1.2em;
            line-height: 1.8;
            margin-bottom: 30px;
            color: var(--text-color, white);
        }
        .emotion-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color, white);
        }
        .color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-color, white);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-color, white);
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        .related-diary-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--text-color, white);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color, white);
        }
        .related-diary-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        .related-diary-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color, white);
        }
        .related-diary-date {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 10px;
            color: var(--text-color, white);
        }
        .related-diary-preview {
            font-size: 1em;
            line-height: 1.5;
            color: var(--text-color, white);
        }
        .empty-message {
            text-align: center;
            opacity: 0.7;
            font-size: 1.1em;
            color: var(--text-color, white);
            padding: 40px 20px;
        }
        .loading {
            text-align: center;
            color: var(--text-color, white);
            font-size: 1.1em;
            padding: 40px;
        }
        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-color, white);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“– ì¼ê¸° ë·°ì–´</h1>
            <a href="/" onclick="window.history.back(); return false;">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
        
        <div class="main-content">
            <!-- ì™¼ìª½: ì„ íƒëœ ì¼ê¸° -->
            <div class="selected-diary" id="selectedDiary">
                <div class="loading">ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½: ê´€ë ¨ ì¼ê¸° -->
            <div class="related-diaries" id="relatedDiaries">
                <div class="loading">ê´€ë ¨ ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        // URLì—ì„œ diary_id ì¶”ì¶œ
        const diaryId = window.location.pathname.split('/').pop();
        
        // ìƒ‰ìƒ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function getContrastColor(hexColor) {
            const rgb = hexToRgb(hexColor);
            if (!rgb) return 'white';
            
            // ë°ê¸° ê³„ì‚° (YIQ ê³µì‹)
            const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            return brightness > 128 ? 'black' : 'white';
        }
        
        function adjustColorBrightness(hex, percent) {
            const num = parseInt(hex.replace("#",""), 16);
            const amt = Math.round(2.55 * percent * 100);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }
        
        function getEmotionEmoji(emotion) {
            const emojiMap = {
                'Happiness': 'ğŸ˜Š',
                'Sadness': 'ğŸ˜¢',
                'Fear': 'ğŸ˜¨',
                'Anger': 'ğŸ˜ ',
                'Surprise': 'ğŸ˜²',
                'Disgust': 'ğŸ¤¢',
                'Neutral': 'ğŸ˜'
            };
            return emojiMap[emotion] || 'ğŸ’­';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ì„ íƒëœ ì¼ê¸° ë¡œë“œ
        function loadSelectedDiary() {
            fetch('/api/diaries')
                .then(r => r.json())
                .then(data => {
                    if (data.success && Array.isArray(data.diaries)) {
                        const diary = data.diaries.find(d => d.id == diaryId);
                        if (diary) {
                            displaySelectedDiary(diary);
                            loadRelatedDiaries(diary.emotion, diary.id);
                        } else {
                            document.getElementById('selectedDiary').innerHTML = 
                                '<div class="empty-message">ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                        }
                    }
                })
                .catch(error => {
                    console.error('ì¼ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('selectedDiary').innerHTML = 
                        '<div class="empty-message">ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                });
        }
        
        // ì„ íƒëœ ì¼ê¸° í‘œì‹œ
        function displaySelectedDiary(diary) {
            const textColor = getContrastColor(diary.color_hex);
            const lightColor = adjustColorBrightness(diary.color_hex, 0.3);
            
            document.documentElement.style.setProperty('--theme-color', diary.color_hex);
            document.documentElement.style.setProperty('--theme-color-light', lightColor);
            document.documentElement.style.setProperty('--text-color', textColor);
            
            const html = `
                <button class="back-button" onclick="window.history.back()">â† ëŒì•„ê°€ê¸°</button>
                <div class="emotion-tag">
                    <span class="color-indicator"></span>
                    ${getEmotionEmoji(diary.emotion)} ${diary.emotion}
                </div>
                <h2 class="diary-title">${escapeHtml(diary.title)}</h2>
                <div class="diary-meta">
                    ğŸ“… ${diary.date} â€¢ ğŸ¨ ${diary.color_name} â€¢ ${diary.tone}
                </div>
                <div class="diary-content">${escapeHtml(diary.content)}</div>
            `;
            
            document.getElementById('selectedDiary').innerHTML = html;
        }
        
        // ê´€ë ¨ ì¼ê¸° ë¡œë“œ
        function loadRelatedDiaries(emotion, currentId) {
            fetch('/api/diaries')
                .then(r => r.json())
                .then(data => {
                    if (data.success && Array.isArray(data.diaries)) {
                        // ê°™ì€ ê°ì •ì˜ ë‹¤ë¥¸ ì¼ê¸° í•„í„°ë§
                        const related = data.diaries
                            .filter(d => d.emotion === emotion && d.id != currentId)
                            .slice(0, 5); // ìµœëŒ€ 5ê°œ
                        
                        displayRelatedDiaries(related);
                    }
                })
                .catch(error => {
                    console.error('ê´€ë ¨ ì¼ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('relatedDiaries').innerHTML = 
                        '<div class="empty-message">ê´€ë ¨ ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                });
        }
        
        // ê´€ë ¨ ì¼ê¸° í‘œì‹œ
        function displayRelatedDiaries(diaries) {
            const container = document.getElementById('relatedDiaries');
            
            if (diaries.length === 0) {
                container.innerHTML = `
                    <h3 class="section-title">ğŸ’­ ê°™ì€ ê°ì •ì˜ ë‹¤ë¥¸ ì¼ê¸°</h3>
                    <div class="empty-message">ì•„ì§ ê°™ì€ ê°ì •ì˜ ë‹¤ë¥¸ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                `;
                return;
            }
            
            const html = `
                <h3 class="section-title">ğŸ’­ ê°™ì€ ê°ì •ì˜ ë‹¤ë¥¸ ì¼ê¸° (${diaries.length}ê°œ)</h3>
                ${diaries.map(diary => `
                    <div class="related-diary-item" onclick="goToDiary(${diary.id})">
                        <div class="related-diary-title">${escapeHtml(diary.title)}</div>
                        <div class="related-diary-date">ğŸ“… ${diary.date}</div>
                        <div class="related-diary-preview">${escapeHtml(diary.content.substring(0, 100))}${diary.content.length > 100 ? '...' : ''}</div>
                    </div>
                `).join('')}
            `;
            
            container.innerHTML = html;
        }
        
        // ì¼ê¸°ë¡œ ì´ë™
        function goToDiary(id) {
            window.location.href = `/diary/${id}`;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            loadSelectedDiary();
        });
    </script>
</body>
</html>